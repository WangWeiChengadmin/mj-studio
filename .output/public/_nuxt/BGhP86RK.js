import{J as re,g as F,K as z,a8 as se,ak as J,aE as $,aF as G,m as j,q as H,I as ie,aA as O,s as oe,O as _,L as g,aG as ue,aH as le,i as ce,o as fe,w as de,N as me,v as pe,n as ye,j as P,ai as ve,aI as he,aJ as Ee}from"./DZ_1_TWT.js";import{u as ge}from"./DDAgXY8S.js";function be(r){return"schema"in r&&typeof r.coercer=="function"&&typeof r.validator=="function"&&typeof r.refiner=="function"}function we(r){return"~standard"in r}async function Se(r,i){const l=await i["~standard"].validate(r);return l.issues?{errors:l.issues?.map(n=>({name:n.path?.map(o=>typeof o=="object"?o.key:o).join(".")||"",message:n.message}))||[],result:null}:{errors:null,result:l.value}}async function Ie(r,i){const[l,n]=i.validate(r);return l?{errors:l.failures().map(h=>({message:h.message,name:h.path.join(".")})),result:null}:{errors:null,result:n}}function Fe(r,i){if(we(i))return Se(r,i);if(be(i))return Ie(r,i);throw new Error("Form validation failed: Unsupported form schema")}function je(r,i){return i?i.split(".").reduce((n,o)=>n?.[o],r):r}function qe(r,i,l){if(!i)return Object.assign(r,l);if(!r)return r;const n=i.split(".");let o=r;for(let y=0;y<n.length-1;y++){const c=n[y];(o[c]===void 0||o[c]===null)&&(y+1<n.length&&!Number.isNaN(Number(n[y+1]))?o[c]=[]:o[c]={}),o=o[c]}const h=n[n.length-1];return o[h]=l,r}class q extends Error{formId;errors;constructor(i,l){super("Form validation exception"),this.formId=i,this.errors=l,Object.setPrototypeOf(this,q.prototype)}}const xe={base:""},Oe={__name:"UForm",props:{id:{type:[String,Number],required:!1},schema:{type:null,required:!1},state:{type:null,required:!1},validate:{type:Function,required:!1},validateOn:{type:Array,required:!1,default(){return["input","blur","change"]}},disabled:{type:Boolean,required:!1},name:{type:null,required:!1},validateOnInputDelay:{type:Number,required:!1,default:300},transform:{type:null,required:!1,default:()=>!0},nested:{type:Boolean,required:!1},loadingAuto:{type:Boolean,required:!1,default:!0},class:{type:null,required:!1},onSubmit:{type:Function,required:!1}},emits:["submit","error"],setup(r,{expose:i,emit:l}){const n=r,o=l,h=re(),y=F(()=>z({extend:z(xe),...h.ui?.form||{}})),c=n.id??se(),A=ge(`form-${c}`),b=n.nested===!0&&J($,void 0),k=n.nested===!0?J(G,void 0):void 0,w=F(()=>k?.value?n.name?je(k.value,n.name):k.value:n.state);g($,A),g(G,w);const S=j(new Map);H(async()=>{b&&(await ie(),b.emit({type:"attach",validate:I,formId:c,name:n.name,api:U}))}),oe(()=>{A.reset(),b&&b.emit({type:"detach",formId:c})}),H(async()=>{A.on(async e=>{e.type==="attach"?S.value.set(e.formId,{validate:e.validate,name:e.name,api:e.api}):e.type==="detach"?S.value.delete(e.formId):n.validateOn?.includes(e.type)&&!v.value&&(e.type!=="input"?await I({name:e.name,silent:!0,nested:!1}):(e.eager||K.has(e.name))&&await I({name:e.name,silent:!0,nested:!1})),e.type==="blur"&&K.add(e.name),(e.type==="change"||e.type==="input"||e.type==="blur"||e.type==="focus")&&R.add(e.name),(e.type==="change"||e.type==="input")&&B.add(e.name)})});const u=j([]);g(he,u);const x=j({});g(Ee,x);const B=_(new Set),R=_(new Set),K=_(new Set);function C(e){return e.map(t=>({...t,id:t?.name?x.value[t.name]?.id:void 0}))}const N=j(null);async function Q(){let e=n.validate?await n.validate(w.value)??[]:[];if(n.schema){const{errors:t,result:a}=await Fe(w.value,n.schema);t?e=e.concat(t):N.value=a}return C(e)}async function I(e={silent:!1,nested:!1,transform:!1}){const t=e.name&&!Array.isArray(e.name)?[e.name]:e.name;let a=[],s=[];if(!t&&e.nested){const p=Array.from(S.value.values()).map(m=>V(m,e)),d=await Promise.all(p);s=d.filter(m=>m.error).flatMap(m=>m.error.errors.map(ne=>X(ne,m.name))),a=d.filter(m=>m.output!==void 0)}const E=[...await Q(),...s];if(t?u.value=te(E,t):u.value=E,u.value?.length){if(e.silent)return!1;throw new q(c,u.value)}return e.transform?(a.forEach(p=>{p.name?qe(N.value,p.name,p.output):Object.assign(N.value,p.output)}),N.value??w.value):w.value}const v=j(!1);g(ue,O(v));async function W(e){v.value=n.loadingAuto&&!0;const t=e;try{t.data=await I({nested:!0,transform:n.transform}),await n.onSubmit?.(t),B.clear()}catch(a){if(!(a instanceof q))throw a;const s={...t,errors:a.errors};o("error",s)}finally{v.value=!1}}const D=F(()=>n.disabled||v.value);g(le,F(()=>({disabled:D.value,validateOnInputDelay:n.validateOnInputDelay})));async function V(e,t){try{const a=await e.validate({...t,silent:!1});return{name:e.name,output:a}}catch(a){if(!(a instanceof q))throw a;return{name:e.name,error:a}}}function X(e,t){return!t||!e.name?e:{...e,name:t+"."+e.name}}function Y(e,t){const a=t+".",s=e?.name?.startsWith(a)?e.name.substring(a.length):e.name;return{...e,name:s}}function Z(e,t){return t?e.filter(a=>a?.name?.startsWith(t+".")).map(a=>Y(a,t)):e}function M(e){return e.api.getErrors().map(t=>e.name?{...t,name:e.name+"."+t.name}:t)}function T(e,t){return!e||!t?!0:e instanceof RegExp?e.test(t):t===e||typeof e=="string"&&e.startsWith(t+".")}function ee(e,t){if(!e||e instanceof RegExp)return e;if(t!==e)return typeof e=="string"&&e.startsWith(t+".")?e.substring(t.length+1):e}function te(e,t){const a=new Set(t),s=t.map(d=>x.value?.[d]?.pattern).filter(Boolean),f=d=>d.name?a.has(d.name)?!0:s.some(m=>m.test(d.name)):!1,E=u.value.filter(d=>!f(d)),p=e.filter(f);return[...E,...p]}function ae(e,t){return e.filter(a=>t instanceof RegExp?!(a.name&&t.test(a.name)):!a.name||a.name!==t)}function L(e){return!e.name||!!x.value[e.name]}const U={validate:I,errors:u,setErrors(e,t){const a=C(e.filter(L)),s=[];for(const f of S.value.values())if(T(t,f.name)){const E=Z(e,f.name);f.api.setErrors(E,ee(t,f.name||"")),s.push(...M(f))}if(t){const f=ae(u.value,t);u.value=[...f,...a,...s]}else u.value=[...a,...s]},async submit(){await W(new Event("submit"))},getErrors(e){return e?u.value.filter(t=>e instanceof RegExp?t.name&&e.test(t.name):t.name===e):u.value},clear(e){const t=e?u.value.filter(s=>L(s)&&(e instanceof RegExp?!(s.name&&e.test(s.name)):s.name!==e)):[],a=[];for(const s of S.value.values())T(e,s.name)&&s.api.clear(),a.push(...M(s));u.value=[...t,...a]},disabled:D,loading:v,dirty:F(()=>!!B.size),dirtyFields:O(B),blurredFields:O(K),touchedFields:O(R)};return i(U),(e,t)=>(fe(),ce(ve(P(b)?"div":"form"),{id:P(c),class:ye(y.value({class:n.class})),onSubmit:pe(W,["prevent"])},{default:de(()=>[me(e.$slots,"default",{errors:u.value,loading:v.value})]),_:3},40,["id","class"]))}};export{Oe as _};
