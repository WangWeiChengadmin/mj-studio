import{f as ce,T as ue,S as de,R as pe,B as me,g as E,m as C,q as fe,p as he,s as ge,c as p,a as o,b as a,i as x,h,w as f,j as n,t as m,n as y,I as we,k as ve,z as _e,o as i,d as k,y as D,F as xe,_ as ye}from"./DZ_1_TWT.js";import{_ as ke}from"./Ds9Pl6UP.js";import{_ as be}from"./CzGMH1O9.js";import{u as $e,_ as Ce,a as Ue,b as Re,c as Ie,d as b,P as $}from"./DffvPA4m.js";import{u as Se}from"./CJsX1qrP.js";import"./9BQeByXX.js";import"./D41R7u62.js";import"./CHEUhdok.js";import"./DDAgXY8S.js";const ze={class:"workflow-run-page flex flex-col h-[calc(100vh-56px)] bg-(--ui-bg) overflow-hidden"},Te={class:"toolbar flex items-center gap-3 px-4 py-2 border-b border-(--ui-border) bg-(--ui-bg-elevated)"},Me={class:"flex items-center gap-2 text-sm"},Ee={class:"text-(--ui-text-muted)"},Ne={class:"flex-1 flex min-h-0"},je={key:0,class:"flex-1 flex items-center justify-center"},Ae={class:"node-header"},Oe={class:"node-content"},Pe={key:0,class:"preview-image"},Be=["src"],Ve={key:1,class:"preview-area"},Le={class:"node-header node-header-gen"},De={key:0,class:"ml-auto"},Fe={key:1,class:"ml-auto"},He={key:2,class:"ml-auto"},qe={class:"node-content"},Je={class:"text-xs text-(--ui-text-muted) mb-2"},We={class:"text-xs mb-2"},Ge={class:"mt-1 text-(--ui-text) line-clamp-2"},Ke={key:0,class:"mt-2"},Qe=["src"],Xe=["title"],Ye={class:"node-header node-header-video"},Ze={key:0,class:"ml-auto"},et={key:1,class:"ml-auto"},tt={key:2,class:"ml-auto"},st={class:"node-content"},ot={class:"text-xs text-(--ui-text-muted) mb-2"},nt={class:"text-xs mb-2"},at={class:"mt-1 text-(--ui-text) line-clamp-2"},rt={key:0,class:"mt-2"},lt=["src"],it=["title"],ct={class:"node-header node-header-text"},ut={class:"node-content"},dt={class:"text-xs text-(--ui-text) line-clamp-4"},pt={class:"node-header node-header-preview"},mt={class:"node-content"},ft=["src"],ht=["src"],gt={key:1,class:"preview-area"},wt={class:"h-full w-full flex items-center justify-center"},vt=ce({__name:"[id]",setup(_t){const F=ue(),O=de(),g=pe(),{getAuthHeader:H}=me(),{loadUpstreams:q}=Se(),w=E(()=>Number(F.params.id)),r=C(null),N=C(new Map),U=C(null),j=C(!0),R=C([]),I=C([]),{fitView:J}=$e();async function W(){j.value=!0;try{const e=await $fetch(`/api/workflow-runs/${w.value}`);r.value=e.data.run,U.value=e.data.snapshot,N.value=new Map(e.data.nodes.map(t=>[t.nodeId,t])),G()}catch(e){g.add({title:"加载运行记录失败",description:e.data?.message,color:"error"}),O.push("/workflows")}finally{j.value=!1}}function G(){U.value&&(R.value=U.value.nodes.map(e=>({...e,data:{...e.data},draggable:!1,selectable:!0})),I.value=U.value.edges.map(e=>({...e,animated:!0,style:{stroke:"#60a5fa"}})),we(()=>{setTimeout(()=>J({padding:.2}),100)}))}function c(e){return N.value.get(e)}function S(e){const t=c(e);if(!t)return"";switch(t.status){case"pending":case"processing":return"node-processing";case"success":return"node-success";case"failed":return"node-failed";case"skipped":return"node-skipped";default:return""}}function z(e){const t=I.value.filter(l=>l.target===e);for(const l of t){const d=R.value.find(T=>T.id===l.source);if(!d)continue;if(d.type==="input-image"&&d.data.imageUrl)return{type:"image",url:d.data.imageUrl};const _=c(d.id);if(_?.outputs?.resourceUrl){if(d.type==="gen-image")return{type:"image",url:_.outputs.resourceUrl};if(d.type==="gen-video")return{type:"video",url:_.outputs.resourceUrl}}}return null}const K=[{value:"normal",label:"普通模式",description:"自动执行所有节点"},{value:"step",label:"单步模式",description:"每个节点执行后暂停"}];async function Q(e){if(!(!r.value||r.value.runMode===e))try{await $fetch(`/api/workflow-runs/${w.value}`,{method:"PATCH",body:{runMode:e}}),r.value.runMode=e,g.add({title:`已切换到${e==="normal"?"普通":"单步"}模式`,color:"success"})}catch(t){g.add({title:"切换模式失败",description:t.data?.message,color:"error"})}}async function P(e){try{await $fetch(`/api/workflow-runs/${w.value}/execute-node`,{method:"POST",body:{nodeId:e}}),g.add({title:"节点执行中",color:"info"})}catch(t){g.add({title:"执行失败",description:t.data?.message,color:"error"})}}async function X(){try{await $fetch(`/api/workflow-runs/${w.value}/continue`,{method:"POST"}),g.add({title:"继续执行中",color:"info"})}catch(e){g.add({title:"继续执行失败",description:e.data?.message,color:"error"})}}async function Y(){try{await $fetch(`/api/workflow-runs/${w.value}/retry`,{method:"POST"}),g.add({title:"重新执行中",color:"info"})}catch(e){g.add({title:"重试失败",description:e.data?.message,color:"error"})}}async function Z(){try{await $fetch(`/api/workflow-runs/${w.value}/cancel`,{method:"POST"}),g.add({title:"已取消执行",color:"warning"})}catch(e){g.add({title:"取消失败",description:e.data?.message,color:"error"})}}function ee(){r.value?.workflowId&&O.push(`/workflow/${r.value.workflowId}`)}const te={pending:"等待中",running:"运行中",paused:"已暂停",completed:"已完成",failed:"失败",cancelled:"已取消"},B={pending:"text-(--ui-text-muted)",running:"text-blue-500",paused:"text-yellow-500",completed:"text-green-500",failed:"text-red-500",cancelled:"text-gray-500"},se={pending:"i-heroicons-clock",running:"i-heroicons-arrow-path",paused:"i-heroicons-pause-circle",completed:"i-heroicons-check-circle",failed:"i-heroicons-x-circle",cancelled:"i-heroicons-stop-circle"},oe=E(()=>r.value?.status==="paused"),ne=E(()=>r.value?.status==="running"),ae=E(()=>["failed","cancelled","completed"].includes(r.value?.status||"")),A=E(()=>["paused","failed","cancelled","completed"].includes(r.value?.status||""));let v=null;async function V(){v&&v.abort(),v=new AbortController;try{const e=await fetch(`/api/workflow-runs/${w.value}/events`,{signal:v.signal,headers:H()});if(!e.ok)throw new Error("订阅失败");const t=e.body?.getReader();if(!t)throw new Error("无法读取响应");const l=new TextDecoder;let d="";for(;;){const{done:_,value:T}=await t.read();if(_)break;d+=l.decode(T,{stream:!0});const s=d.split(`
`);d=s.pop()||"";for(const u of s){const M=u.trim();if(!M||!M.startsWith("data:"))continue;const le=M.slice(5).trim();try{const ie=JSON.parse(le);re(ie)}catch{}}}}catch(e){if(e.name==="AbortError")return;console.error("SSE 订阅错误:",e),setTimeout(()=>{(r.value?.status==="running"||r.value?.status==="pending")&&V()},5e3)}}function re(e){switch(e.type){case"run_status":r.value&&(r.value.status=e.status);break;case"run_mode_changed":r.value&&(r.value.runMode=e.runMode);break;case"run_node_status":{const t=N.value.get(e.nodeId);t?(t.status=e.status,e.outputs&&(t.outputs=e.outputs),e.error&&(t.error=e.error)):N.value.set(e.nodeId,{id:0,runId:w.value,nodeId:e.nodeId,status:e.status,outputs:e.outputs,error:e.error,inputs:null,startedAt:null,completedAt:null,createdAt:new Date});break}}}function L(){v&&(v.abort(),v=null)}return fe(()=>{W(),q()}),he(()=>r.value?.status,(e,t)=>{e==="running"||e==="pending"?V():(t==="running"||t==="pending")&&setTimeout(()=>{r.value?.status!=="running"&&r.value?.status!=="pending"&&L()},2e3)},{immediate:!0}),ge(()=>{L()}),(e,t)=>{const l=ve,d=_e,_=ke,T=be;return i(),p("div",ze,[o("div",Te,[a(d,{variant:"ghost",size:"sm",onClick:ee},{default:f(()=>[a(l,{name:"i-heroicons-arrow-left",class:"w-4 h-4 mr-1"}),t[2]||(t[2]=k(" 返回编辑 ",-1))]),_:1}),t[6]||(t[6]=o("div",{class:"h-4 w-px bg-(--ui-border)"},null,-1)),n(A)?(i(),x(d,{key:0,variant:"outline",size:"sm",onClick:X,disabled:!n(oe)},{default:f(()=>[a(l,{name:"i-heroicons-play",class:"w-4 h-4 mr-1"}),t[3]||(t[3]=k(" 继续运行 ",-1))]),_:1},8,["disabled"])):h("",!0),n(ne)?(i(),x(d,{key:1,variant:"outline",size:"sm",color:"warning",onClick:Z},{default:f(()=>[a(l,{name:"i-heroicons-stop",class:"w-4 h-4 mr-1"}),t[4]||(t[4]=k(" 中止 ",-1))]),_:1})):h("",!0),n(ae)?(i(),x(d,{key:2,variant:"outline",size:"sm",onClick:Y},{default:f(()=>[a(l,{name:"i-heroicons-arrow-path",class:"w-4 h-4 mr-1"}),t[5]||(t[5]=k(" 重试 ",-1))]),_:1})):h("",!0),t[7]||(t[7]=o("div",{class:"flex-1"},null,-1)),a(_,{items:K.map(s=>({label:s.label,click:()=>Q(s.value),active:n(r)?.runMode===s.value}))},{default:f(()=>[a(d,{variant:"ghost",size:"sm"},{default:f(()=>[k(m(n(r)?.runMode==="step"?"单步模式":"普通模式")+" ",1),a(l,{name:"i-heroicons-chevron-down",class:"w-4 h-4 ml-1"})]),_:1})]),_:1},8,["items"]),t[8]||(t[8]=o("div",{class:"h-4 w-px bg-(--ui-border)"},null,-1)),o("div",Me,[o("span",Ee,"Run #"+m(n(r)?.id),1),n(r)?(i(),x(l,{key:0,name:se[n(r).status],class:y(["w-4 h-4",[B[n(r).status],n(r).status==="running"&&"animate-spin"]])},null,8,["name","class"])):h("",!0),n(r)?(i(),p("span",{key:1,class:y(B[n(r).status])},m(te[n(r).status]),3)):h("",!0)])]),o("div",Ne,[n(j)?(i(),p("div",je,[a(l,{name:"i-heroicons-arrow-path",class:"w-8 h-8 animate-spin text-(--ui-text-muted)"})])):(i(),x(T,{key:1},{fallback:f(()=>[o("div",wt,[a(l,{name:"i-heroicons-arrow-path",class:"w-8 h-8 animate-spin text-zinc-500"})])]),default:f(()=>[a(n(Ce),{nodes:n(R),"onUpdate:nodes":t[0]||(t[0]=s=>D(R)?R.value=s:null),edges:n(I),"onUpdate:edges":t[1]||(t[1]=s=>D(I)?I.value=s:null),"default-viewport":n(U)?.viewport||{x:0,y:0,zoom:1},"min-zoom":.2,"max-zoom":3,"nodes-draggable":!1,"nodes-connectable":!1,"edges-updatable":!1,class:"workflow-canvas"},{"node-input-image":f(({id:s,data:u})=>[o("div",{class:y(["workflow-node node-input",S(s)])},[o("div",Ae,[a(l,{name:"i-heroicons-photo",class:"w-4 h-4"}),o("span",null,m(u.label),1)]),o("div",Oe,[u.imageUrl?(i(),p("div",Pe,[o("img",{src:u.imageUrl,class:"w-full h-full object-cover rounded"},null,8,Be)])):(i(),p("div",Ve,[a(l,{name:"i-heroicons-photo",class:"w-8 h-8 text-(--ui-text-dimmed)"}),t[9]||(t[9]=o("span",{class:"text-xs text-(--ui-text-muted)"},"无图片",-1))]))]),a(n(b),{type:"source",position:n($).Right,class:"handle-source"},null,8,["position"])],2)]),"node-gen-image":f(({id:s,data:u})=>[o("div",{class:y(["workflow-node node-gen",S(s)])},[o("div",Le,[a(l,{name:"i-heroicons-sparkles",class:"w-4 h-4"}),o("span",null,m(u.label),1),c(s)?.status==="processing"?(i(),p("span",De,[a(l,{name:"i-heroicons-arrow-path",class:"w-3 h-3 animate-spin text-blue-400"})])):c(s)?.status==="success"?(i(),p("span",Fe,[a(l,{name:"i-heroicons-check-circle",class:"w-3 h-3 text-green-400"})])):c(s)?.status==="failed"?(i(),p("span",He,[a(l,{name:"i-heroicons-x-circle",class:"w-3 h-3 text-red-400"})])):h("",!0)]),o("div",qe,[o("div",Je," 模型: "+m(u.aimodelId?`#${u.aimodelId}`:"未选择"),1),o("div",We,[t[10]||(t[10]=o("span",{class:"text-(--ui-text-muted)"},"提示词:",-1)),o("p",Ge,m(u.prompt||"无"),1)]),c(s)?.outputs?.resourceUrl?(i(),p("div",Ke,[o("img",{src:c(s)?.outputs?.resourceUrl,class:"w-full h-24 object-cover rounded"},null,8,Qe)])):h("",!0),c(s)?.error?(i(),p("div",{key:1,class:"mt-2 text-[10px] text-red-400 truncate",title:c(s)?.error||""},m(c(s)?.error),9,Xe)):h("",!0),n(A)?(i(),x(d,{key:2,size:"xs",color:"primary",class:"w-full mt-2",loading:c(s)?.status==="processing",disabled:c(s)?.status==="processing",onClick:M=>P(s)},{default:f(()=>[a(l,{name:"i-heroicons-play",class:"w-3 h-3 mr-1"}),k(" "+m(c(s)?.status==="processing"?"生成中...":"执行"),1)]),_:2},1032,["loading","disabled","onClick"])):h("",!0)]),a(n(b),{type:"target",position:n($).Left,class:"handle-target"},null,8,["position"]),a(n(b),{type:"source",position:n($).Right,class:"handle-source"},null,8,["position"])],2)]),"node-gen-video":f(({id:s,data:u})=>[o("div",{class:y(["workflow-node node-video",S(s)])},[o("div",Ye,[a(l,{name:"i-heroicons-film",class:"w-4 h-4"}),o("span",null,m(u.label),1),c(s)?.status==="processing"?(i(),p("span",Ze,[a(l,{name:"i-heroicons-arrow-path",class:"w-3 h-3 animate-spin text-purple-400"})])):c(s)?.status==="success"?(i(),p("span",et,[a(l,{name:"i-heroicons-check-circle",class:"w-3 h-3 text-green-400"})])):c(s)?.status==="failed"?(i(),p("span",tt,[a(l,{name:"i-heroicons-x-circle",class:"w-3 h-3 text-red-400"})])):h("",!0)]),o("div",st,[o("div",ot," 模型: "+m(u.aimodelId?`#${u.aimodelId}`:"未选择"),1),o("div",nt,[t[11]||(t[11]=o("span",{class:"text-(--ui-text-muted)"},"提示词:",-1)),o("p",at,m(u.prompt||"无"),1)]),c(s)?.outputs?.resourceUrl?(i(),p("div",rt,[o("video",{src:c(s)?.outputs?.resourceUrl,class:"w-full h-24 object-cover rounded",controls:""},null,8,lt)])):h("",!0),c(s)?.error?(i(),p("div",{key:1,class:"mt-2 text-[10px] text-red-400 truncate",title:c(s)?.error||""},m(c(s)?.error),9,it)):h("",!0),n(A)?(i(),x(d,{key:2,size:"xs",color:"secondary",class:"w-full mt-2",loading:c(s)?.status==="processing",disabled:c(s)?.status==="processing",onClick:M=>P(s)},{default:f(()=>[a(l,{name:"i-heroicons-play",class:"w-3 h-3 mr-1"}),k(" "+m(c(s)?.status==="processing"?"生成中...":"执行"),1)]),_:2},1032,["loading","disabled","onClick"])):h("",!0)]),a(n(b),{type:"target",position:n($).Left,class:"handle-target"},null,8,["position"]),a(n(b),{type:"source",position:n($).Right,class:"handle-source"},null,8,["position"])],2)]),"node-text-node":f(({id:s,data:u})=>[o("div",{class:y(["workflow-node node-text",S(s)])},[o("div",ct,[a(l,{name:"i-heroicons-document-text",class:"w-4 h-4"}),o("span",null,m(u.label),1)]),o("div",ut,[o("p",dt,m(u.text||"无内容"),1)]),a(n(b),{type:"source",position:n($).Right,class:"handle-source"},null,8,["position"])],2)]),"node-preview":f(({id:s,data:u})=>[o("div",{class:y(["workflow-node node-preview",S(s)])},[o("div",pt,[a(l,{name:"i-heroicons-eye",class:"w-4 h-4"}),o("span",null,m(u.label),1)]),o("div",mt,[z(s)?(i(),p(xe,{key:0},[z(s)?.type==="image"?(i(),p("img",{key:0,src:z(s)?.url,class:"w-full h-32 object-contain rounded bg-(--ui-bg-muted)"},null,8,ft)):z(s)?.type==="video"?(i(),p("video",{key:1,src:z(s)?.url,class:"w-full h-32 object-contain rounded bg-(--ui-bg-muted)",controls:""},null,8,ht)):h("",!0)],64)):(i(),p("div",gt,[a(l,{name:"i-heroicons-photo",class:"w-12 h-12 text-(--ui-text-dimmed)"}),t[12]||(t[12]=o("span",{class:"text-xs text-(--ui-text-muted)"},"等待输入",-1))]))]),a(n(b),{type:"target",position:n($).Left,class:"handle-target"},null,8,["position"])],2)]),default:f(()=>[a(n(Ue),{gap:20,size:1,class:"workflow-background"}),a(n(Re),{pannable:!0,zoomable:!0}),a(n(Ie),{"show-fit-view":!0,"show-interactive":!1})]),_:1},8,["nodes","edges","default-viewport"])]),_:1}))])])}}}),St=ye(vt,[["__scopeId","data-v-f7a92467"]]);export{St as default};
